<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.1/redux.js" integrity="sha512-aU+9st6E3LYPknXJiOkhUXxYz/QbB1IDf1YUYzCCbgiwOCu2g/1pH+68ROdxC3clouCOVfO6u2g7qoB43rfmQg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>
    <body>
        <div id="subject"></div>
        <div id="toc"></div>
        <div id="control"></div>
        <div id="article"></div>
        <script>
            function subject(){
                document.querySelector('#subject').innerHTML =`
                    <header>
                        <h1>WEB</h1>
                        Hello, WEB!
                    </header>
                `
            }
            function TOC(){
                var state = store.getState();
                var temp = '';
                state.contents.map((item)=>{
                    temp += `<li><a onclick="
                            event.preventDefault();
                            var action = {type : 'SELECT', id : ${item.id}, mode : 'read'}
                            store.dispatch(action);
                        "
                        href="${item.id}.html">${item.title}</a></li>`;
                })
                document.querySelector('#toc').innerHTML = `
                <nav>
                    <ol> 
                        ${temp}
                    </ol>
                </nav>
                `
            }
            function control(){
                var state = store.getState();
                var display = state.mode ==="read"? "block" : "none";
        
                document.querySelector('#control').innerHTML=`
                <ul>
                    <li><a onclick="event.preventDefault();
                            var action = {type : 'CHANGE_MODE', mode : 'create'}
                            store.dispatch(action);
                        " href="/create">create</a></li>
                    <li style ="display:${display}"><input type="button" value="delete" onclick="
                            event.preventDefault();
                            var action = {type: 'DELETE', mode: 'welcome'};
                            store.dispatch(action);
                        "/></li>
                </ul>
                `
            }
            function article(){
                var state = store.getState();
                console.log("state.mode::::", state.mode);

                if(state.mode === 'create'){
                    document.querySelector('#article').innerHTML =`
                        <article>
                            <form onsubmit="
                                event.preventDefault();
                                var _title = this.title.value;
                                var _desc = this.desc.value;
                                store.dispatch({type : 'CREATE', title : _title, desc : _desc})
                            ">
                                <p>
                                    <input type="text" name="title" placeholder="title" />
                                </p>
                                <p>
                                    <textarea name="desc" placeholder="description"></textarea>
                                </p>
                                <p>
                                    <input type="submit" />
                                </p>
                            </form>
                        </article>
                    
                    `

                }else if(state.mode ==='read'){
                    console.log("state.select_id:::", state.select_id);
                    var temp = state.contents.find((item) => item.id === state.select_id);

                    // var i = 0;
                    // var aTitle;
                    // var aDesc;
                    // while(i<state.contents.length){
                    //     if(state.contents[i] == state.select_id){
                    //         aTitle = state.contents[i].title;
                    //         aDesc = state.contents[i].aDesc;
                    //         break;
                    //     }
                    //     i+= 1;
                    // }

                    if(!!temp){
                        document.querySelector('#article').innerHTML =`
                    <article>
                        <h2>${temp.title}</h2>
                        ${temp.desc}
                        <p><button type="button" onclick="
                            event.preventDefault();
                            store.dispatch({type: 'CHANGE_MODE', mode: 'update'})
                            ">수정</button></p>
                    </article>                    
                    `
                    }

                } else if(state.mode ==='welcome'){
                    document.querySelector('#article').innerHTML =`
                        <article>
                            <h2>Welcome</h2>
                            Hello, Redux!!
                        </article>
                    `
                } else if(state.mode ==='update'){
                    console.log("state.select_id:::", state.select_id);
                    var temp = state.contents.find((item) => item.id === state.select_id);

                    if(!!temp){
                        document.querySelector('#article').innerHTML =`
                    <article>
                        <form onsubmit="
                            event.preventDefault();
                            var _title = this.title.value;
                            var _desc = this.desc.value;
                            store.dispatch({type : 'UPDATE', title : _title, desc : _desc})
                        ">
                            <p><input type="text" value="${temp.title}" name="title" /></p>
                            <p><input type="text" value="${temp.desc}" name="desc" /></p>
                            <p><input type="submit" /></p>
                        </form>
                    </article>                    
                    `
                    }

                }
            }
            
            function reducer(state, action){
                console.log("action:::", action);
                if(state === undefined){
                    return {
                        max_id : 2,
                        mode : "welcome",
                        select_id : null,
                        contents: [
                            {id: 1, title: 'HTML', desc:'HTML is...'},
                            {id: 2, title: 'CSS', desc:'CSS is...'}
                        ]
                    }
                }
                var newState;
                if(action.type ==='SELECT'){
                    newState = Object.assign({}, state, {select_id : action.id, mode : action.mode})
                } else if(action.type === 'CREATE') {

                    // var maxId = state.contents[0].id;
                    // for(var i = 0; i<state.contents.length; i++){
                    //     if(state.contents[i].id > maxId){
                    //         maxId = state.contents[i].id;
                    //     }
                    // }
                    var newContents = [... state.contents];
                    newContents.push({id : state.max_id + 1 ,title : action.title, desc : action.desc});
                    newState = Object.assign({}, state, {contents : newContents, mode : 'read' , max_id : state.max_id + 1, select_id : state.max_id + 1})

                } else if(action.type === 'DELETE'){

                    // var newContents = [];
                    // var i = 0;
                    // while(i < state.contents.length) {
                    //     if(state.select_id !== state.contents[i].id){
                    //         newContents.push(
                    //             state.contents[i]
                    //         );
                    //     }
                    //     i++;
                    // }
                    // newState = Object.assign({}, state, {
                    //     contents:newContents,
                    //     mode: 'welcome'
                    // })


                    var newContents = [... state.contents];
                    const index = newContents.findIndex(obj => obj.id === state.select_id);
                    if(index != -1){
                        newContents.splice(index, 1);
                        console.log(state.max_id === state.select_id? state.max_id -1 : state.max_id);
                        newState = Object.assign({}, state, {contents : newContents, max_id : state.max_id === state.select_id? state.max_id -1 : state.max_id, mode : 'welcome'});
                    }

                } else if(action.type === 'CHANGE_MODE'){
                    newState = Object.assign({}, state, {mode : action.mode});
                } else if(action.type === 'UPDATE'){
                    var newContents = [... state.contents];
                    newContents.find(item=>{
                        if(item.id === state.select_id){
                            item.title = action.title;
                            item.desc = action.desc;
                        }
                    });
                    console.log("newContents:::", newContents);
                    newState = Object.assign({}, state, {contents : newContents, mode : "read"})
                }
                console.log(action, state, newState);
                return newState;
            }

            var store = Redux.createStore(reducer);
            store.subscribe(article);
            store.subscribe(TOC);
            store.subscribe(control);
            subject();
            TOC();
            control();
            article();
        </script>


    </body>

</html>